package com.abhishek.sit;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;

import java.io.File;
import java.io.IOException;
import java.nio.file.Files;
import java.nio.file.Paths;
import java.util.*;

@Service
public class StatusService {

    private final SitRepository sitRepository;

    @Autowired
    public StatusService(SitRepository sitRepository) {
        this.sitRepository = sitRepository;
    }

    public void handleStatus() {
        if (!sitRepository.isInitialized()) {
            System.out.println("Not a sit repository (or any of the parent directories): .sit");
            return;
        }

        try {
            // 1. Get HEAD commit files
            Map<String, String> headFiles = getHeadFiles(); // Path -> Hash

            // 2. Scan current working directory
            List<File> currentFiles = SitUtil.scanDirectory(new File("."),
                    new HashSet<>(Arrays.asList(".sit", ".git", "build", "gradle", "target")));

            Set<String> untracked = new TreeSet<>();
            Set<String> modified = new TreeSet<>();
            Set<String> clean = new TreeSet<>();

            for (File file : currentFiles) {
                String relPath = getRelativePath(file);
                byte[] content = Files.readAllBytes(file.toPath());
                String currentHash = SitUtil.getSha1(content);

                if (!headFiles.containsKey(relPath)) {
                    untracked.add(relPath);
                } else {
                    String headHash = headFiles.get(relPath);
                    if (!headHash.equals(currentHash)) {
                        modified.add(relPath);
                    } else {
                        clean.add(relPath);
                    }
                    headFiles.remove(relPath); // Processed
                }
            }

            // Remaining headFiles are "deleted"
            Set<String> deleted = new TreeSet<>(headFiles.keySet());

            printStatus(untracked, modified, deleted);

        } catch (IOException e) {
            System.err.println("Error calculating status: " + e.getMessage());
        }
    }

    private Map<String, String> getHeadFiles() throws IOException {
        Map<String, String> files = new HashMap<>();
        String headCommitId = sitRepository.getHeadCommitId();
        if (headCommitId == null) {
            return files; // No commits yet
        }

        // Parse commit file to get file list
        File commitFile = new File(SitRepository.COMMITS_DIR, headCommitId);
        if (!commitFile.exists())
            return files;

        List<String> lines = Files.readAllLines(commitFile.toPath());
        // Simple Commit Format assumption:
        // parent: <id>
        // author: ...
        // date: ...
        // message: ...
        //
        // path/to/file1 <hash>
        // path/to/file2 <hash>

        boolean parsingFiles = false;
        for (String line : lines) {
            if (line.isEmpty()) {
                parsingFiles = true;
                continue;
            }
            if (parsingFiles) {
                String[] parts = line.split(" ");
                if (parts.length >= 2) {
                    files.put(parts[0], parts[1]);
                }
            }
        }
        return files;
    }

    private String getRelativePath(File file) {
        String path = file.getPath().replace("\\", "/");
        if (path.startsWith("./")) {
            return path.substring(2);
        }
        return path;
    }

    private void printStatus(Set<String> untracked, Set<String> modified, Set<String> deleted) {
        if (untracked.isEmpty() && modified.isEmpty() && deleted.isEmpty()) {
            System.out.println("nothing to commit, working tree clean");
            return;
        }

        if (!modified.isEmpty() || !deleted.isEmpty()) {
            System.out.println("Changes not staged for commit:");
            for (String file : modified) {
                System.out.println("\tmodified:   " + file);
            }
            for (String file : deleted) {
                System.out.println("\tdeleted:    " + file);
            }
            System.out.println();
        }

        if (!untracked.isEmpty()) {
            System.out.println("Untracked files:");
            for (String file : untracked) {
                System.out.println("\t" + file);
            }
            System.out.println();
        }
    }
}
